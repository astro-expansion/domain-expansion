---
title: An actual explanation of what is going on here
---

After reading the Tale of the Three Mages, you might be a little confused, so here's an actual explanation of how 
Domain Expansion works under the hood.

## How Astro builds your site

Whenever you run `astro build`, Astro will essentially "request" your components internally and save the 
resulting HTML. This is done using a function called `$$createComponent`. This function takes in a callback 
(the compiled version of your component) and turns it into an instance of a component. That instance is then called
each time the component is rendered, with your properties, slots and so on. 
You can see how this looks internally in the Astro runtime [here](https://live-astro-compiler.vercel.app/):

```ts
import {
  Fragment,
  render as $$render,
  createAstro as $$createAstro,
  createComponent as $$createComponent,
  renderComponent as $$renderComponent,
  renderHead as $$renderHead,
  maybeRenderHead as $$maybeRenderHead,
  unescapeHTML as $$unescapeHTML,
  renderSlot as $$renderSlot,
  mergeSlots as $$mergeSlots,
  addAttribute as $$addAttribute,
  spreadAttributes as $$spreadAttributes,
  defineStyleVars as $$defineStyleVars,
  defineScriptVars as $$defineScriptVars,
  renderTransition as $$renderTransition,
  createTransitionScope as $$createTransitionScope,
  renderScript as $$renderScript,
  
} from "astro/runtime/server/index.js";
import Foo from './Foo.astro';
import Bar from './Bar.astro';

const $$stdin = $$createComponent(($$result, $$props, $$slots) => {

return $$render`${$$maybeRenderHead($$result)}<div>
    ${$$renderComponent($$result,'Foo',Foo,{},{"default": () => $$render`
        Domain Expansion
    `,})}
    ${$$renderComponent($$result,'Bar',Bar,{"baz":"tizio"})}
</div>`;
}, '<stdin>', undefined);
export default $$stdin;

```
You can see how the `$$createComponent` function takes in the callback, which returns a few
template tags, essentially the rendered components.

## Intercepting the build process

When you install Domain Expansion and add the integration, it adds a Vite plugin. This plugin essentially
just wraps the `$$createComponent` function to add extra behavior before and after your component renders.
That extra behavior allows us to cache all information about each use of your component, such that, whenever
it is built again without any changes to the source code, props or slots, we just return the cached content.

The cache is saved in `node_modules/.domain-expansion`.

## What about assets?

Astro has built-in image optimization. That built-in image optimization adds the resulting asset to your build
output based on calls to the [`getImage` function](https://docs.astro.build/en/guides/images/#generating-images-with-getimage). 
That function is also used in the [`<Image />`](https://docs.astro.build/en/guides/images/#display-optimized-images-with-the-image--component) 
and [`<Picture />`](https://docs.astro.build/en/reference/modules/astro-assets/#picture-)
components. Domain Expansion detects when that function is called and also adds the parameters that the function
was called with to the cache. Whenever we reconstruct a component from the cache, we "replay" all calls to `getImage`	
such that the image service is called just as if the component was rendered normally.
